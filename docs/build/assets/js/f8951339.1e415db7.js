"use strict";(globalThis.webpackChunkmcpkit_docs=globalThis.webpackChunkmcpkit_docs||[]).push([[551],{8453(e,n,r){r.d(n,{R:()=>i,x:()=>c});var t=r(6540);const s={},a=t.createContext(s);function i(e){const n=t.useContext(a);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),t.createElement(a.Provider,{value:n},e.children)}},9527(e,n,r){r.r(n),r.d(n,{assets:()=>o,contentTitle:()=>c,default:()=>p,frontMatter:()=>i,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"guides/tracing-decorator","title":"Distributed Tracing with @Traced","description":"The @Traced decorator adds OpenTelemetry-compatible distributed tracing to your MCP server methods. This enables you to track request flow, measure performance, and debug issues across your application.","source":"@site/docs/guides/tracing-decorator.md","sourceDirName":"guides","slug":"/guides/tracing-decorator","permalink":"/mcpkit/docs/guides/tracing-decorator","draft":false,"unlisted":false,"editUrl":"https://github.com/mcpkit-dev/mcpkit/tree/main/docs/docs/guides/tracing-decorator.md","tags":[],"version":"current","sidebarPosition":7,"frontMatter":{"sidebar_position":7},"sidebar":"tutorialSidebar","previous":{"title":"Debugging & Monitoring","permalink":"/mcpkit/docs/guides/debugging"},"next":{"title":"Middleware","permalink":"/mcpkit/docs/advanced/middleware"}}');var s=r(4848),a=r(8453);const i={sidebar_position:7},c="Distributed Tracing with @Traced",o={},d=[{value:"Quick Start",id:"quick-start",level:2},{value:"Setting Up the Tracer",id:"setting-up-the-tracer",level:2},{value:"Basic Console Tracer",id:"basic-console-tracer",level:3},{value:"Production Tracer (OTLP/Jaeger)",id:"production-tracer-otlpjaeger",level:3},{value:"Testing with Memory Exporter",id:"testing-with-memory-exporter",level:3},{value:"@Traced Options",id:"traced-options",level:2},{value:"Custom Span Name",id:"custom-span-name",level:3},{value:"Adding Attributes",id:"adding-attributes",level:3},{value:"Recording Results",id:"recording-results",level:3},{value:"Span Kinds",id:"span-kinds",level:3},{value:"Manual Tracing Functions",id:"manual-tracing-functions",level:2},{value:"traced() - Wrap Any Function",id:"traced---wrap-any-function",level:3},{value:"withTrace() - Create Spans Manually",id:"withtrace---create-spans-manually",level:3},{value:"Nested Spans",id:"nested-spans",level:3},{value:"Using with Tracing Plugin",id:"using-with-tracing-plugin",level:2},{value:"Tracer Configuration Reference",id:"tracer-configuration-reference",level:2},{value:"Span Attributes Convention",id:"span-attributes-convention",level:2},{value:"Error Handling",id:"error-handling",level:2},{value:"Best Practices",id:"best-practices",level:2},{value:"See Also",id:"see-also",level:2}];function l(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,a.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"distributed-tracing-with-traced",children:"Distributed Tracing with @Traced"})}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"@Traced"})," decorator adds OpenTelemetry-compatible distributed tracing to your MCP server methods. This enables you to track request flow, measure performance, and debug issues across your application."]}),"\n",(0,s.jsx)(n.h2,{id:"quick-start",children:"Quick Start"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"import { MCPServer, Tool, Param, Traced, setGlobalTracer, createTracer, consoleExporter } from '@mcpkit-dev/core';\n\n// Setup tracer (do this once at startup)\nconst tracer = createTracer({\n  serviceName: 'my-mcp-server',\n  exporters: [consoleExporter()],\n});\nsetGlobalTracer(tracer);\n\n@MCPServer({ name: 'my-server', version: '1.0.0' })\nclass MyServer {\n  @Tool({ description: 'Process data' })\n  @Traced()  // Automatically creates spans for this method\n  async processData(@Param({ name: 'input' }) input: string) {\n    return { processed: input.toUpperCase() };\n  }\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Console Output:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'{\n  "name": "tool:processData",\n  "kind": "internal",\n  "status": "ok",\n  "duration": 5,\n  "attributes": {\n    "mcp.tool.name": "processData",\n    "mcp.tool.args.input": "hello"\n  }\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"setting-up-the-tracer",children:"Setting Up the Tracer"}),"\n",(0,s.jsxs)(n.p,{children:["Before using ",(0,s.jsx)(n.code,{children:"@Traced"}),", you must configure a global tracer:"]}),"\n",(0,s.jsx)(n.h3,{id:"basic-console-tracer",children:"Basic Console Tracer"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"import { createTracer, setGlobalTracer, consoleExporter } from '@mcpkit-dev/core';\n\nconst tracer = createTracer({\n  serviceName: 'my-server',\n  serviceVersion: '1.0.0',\n  exporters: [consoleExporter()],\n});\n\nsetGlobalTracer(tracer);\n"})}),"\n",(0,s.jsx)(n.h3,{id:"production-tracer-otlpjaeger",children:"Production Tracer (OTLP/Jaeger)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"import { createTracer, setGlobalTracer } from '@mcpkit-dev/core';\n\nconst tracer = createTracer({\n  serviceName: 'my-server',\n  serviceVersion: '1.0.0',\n  environment: 'production',\n  exporters: [\n    {\n      type: 'otlp',\n      endpoint: 'http://jaeger:4318/v1/traces',\n      headers: { 'Authorization': 'Bearer token' },\n    },\n  ],\n});\n\nsetGlobalTracer(tracer);\n"})}),"\n",(0,s.jsx)(n.h3,{id:"testing-with-memory-exporter",children:"Testing with Memory Exporter"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"import { createTracer, setGlobalTracer, memoryExporter } from '@mcpkit-dev/core';\n\nconst exporter = memoryExporter();\nconst tracer = createTracer({\n  serviceName: 'test-server',\n  exporters: [exporter],\n});\n\nsetGlobalTracer(tracer);\n\n// After running code...\nconst spans = exporter.getSpans();\nconsole.log('Captured spans:', spans.length);\n\n// Clear spans between tests\nexporter.clear();\n"})}),"\n",(0,s.jsx)(n.h2,{id:"traced-options",children:"@Traced Options"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"interface TracedOptions {\n  // Custom span name (default: \"type:methodName\")\n  name?: string;\n\n  // Span kind: 'internal', 'server', 'client' (default: 'internal')\n  kind?: 'internal' | 'server' | 'client';\n\n  // Static attributes to add to span\n  attributes?: SpanAttributes;\n\n  // Extract attributes from method arguments\n  extractAttributes?: (...args: unknown[]) => SpanAttributes;\n\n  // Record result in span attributes (default: false)\n  recordResult?: boolean;\n\n  // Max size for result in attributes (default: 1000 chars)\n  maxResultSize?: number;\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"custom-span-name",children:"Custom Span Name"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"@Tool({ description: 'Send notification' })\n@Traced({ name: 'notifications.send' })\nasync sendNotification(@Param({ name: 'userId' }) userId: string) {\n  // Span will be named \"notifications.send\" instead of \"tool:sendNotification\"\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"adding-attributes",children:"Adding Attributes"}),"\n",(0,s.jsx)(n.p,{children:"Static attributes:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"@Tool({ description: 'Process payment' })\n@Traced({\n  attributes: {\n    'payment.provider': 'stripe',\n    'payment.currency': 'USD',\n  },\n})\nasync processPayment(@Param({ name: 'amount' }) amount: number) {\n  // ...\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:"Dynamic attributes from arguments:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"@Tool({ description: 'Fetch user' })\n@Traced({\n  extractAttributes: (userId: string, options?: { includeOrders: boolean }) => ({\n    'user.id': userId,\n    'fetch.includeOrders': options?.includeOrders ?? false,\n  }),\n})\nasync fetchUser(\n  @Param({ name: 'userId' }) userId: string,\n  @Param({ name: 'options', optional: true }) options?: { includeOrders: boolean }\n) {\n  // ...\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"recording-results",children:"Recording Results"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"@Tool({ description: 'Search products' })\n@Traced({\n  recordResult: true,\n  maxResultSize: 500, // Truncate results longer than 500 chars\n})\nasync searchProducts(@Param({ name: 'query' }) query: string) {\n  const products = await db.search(query);\n  return products; // Result will be in span attributes\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"span-kinds",children:"Span Kinds"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// Internal processing (default)\n@Traced({ kind: 'internal' })\n\n// Handling incoming request\n@Traced({ kind: 'server' })\n\n// Making outbound call\n@Traced({ kind: 'client' })\n"})}),"\n",(0,s.jsx)(n.h2,{id:"manual-tracing-functions",children:"Manual Tracing Functions"}),"\n",(0,s.jsxs)(n.p,{children:["For more control, use the ",(0,s.jsx)(n.code,{children:"traced()"})," and ",(0,s.jsx)(n.code,{children:"withTrace()"})," functions:"]}),"\n",(0,s.jsx)(n.h3,{id:"traced---wrap-any-function",children:"traced() - Wrap Any Function"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"import { traced, getGlobalTracer } from '@mcpkit-dev/core';\n\nconst tracer = getGlobalTracer();\n\n// Wrap an async function\nconst fetchWithTrace = traced(\n  tracer,\n  'http.fetch',\n  async (url: string) => {\n    const response = await fetch(url);\n    return response.json();\n  },\n  {\n    kind: 'client',\n    extractAttributes: (url) => ({ 'http.url': url }),\n  }\n);\n\n// Use it\nconst data = await fetchWithTrace('https://api.example.com/data');\n"})}),"\n",(0,s.jsx)(n.h3,{id:"withtrace---create-spans-manually",children:"withTrace() - Create Spans Manually"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"import { withTrace, getGlobalTracer } from '@mcpkit-dev/core';\n\nconst tracer = getGlobalTracer();\n\nasync function complexOperation() {\n  // Create a span for a specific section\n  const result = await withTrace(\n    tracer,\n    'database.query',\n    async (span) => {\n      span.setAttribute('db.system', 'postgresql');\n      span.setAttribute('db.statement', 'SELECT * FROM users');\n\n      const users = await db.query('SELECT * FROM users');\n\n      span.setAttribute('db.rows_returned', users.length);\n      return users;\n    },\n    { kind: 'client' }\n  );\n\n  return result;\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"nested-spans",children:"Nested Spans"}),"\n",(0,s.jsx)(n.p,{children:"Spans automatically nest to show call hierarchy:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"@Tool({ description: 'Process order' })\n@Traced({ name: 'order.process' })\nasync processOrder(@Param({ name: 'orderId' }) orderId: string) {\n  // Child span for validation\n  await withTrace(tracer, 'order.validate', async () => {\n    await this.validateOrder(orderId);\n  });\n\n  // Child span for payment\n  await withTrace(tracer, 'order.payment', async (span) => {\n    span.setAttribute('payment.method', 'credit_card');\n    await this.chargePayment(orderId);\n  });\n\n  // Child span for fulfillment\n  await withTrace(tracer, 'order.fulfill', async () => {\n    await this.fulfillOrder(orderId);\n  });\n\n  return { status: 'completed' };\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Trace Hierarchy:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"order.process (15ms)\n\u251c\u2500\u2500 order.validate (2ms)\n\u251c\u2500\u2500 order.payment (8ms)\n\u2502   \u2514\u2500\u2500 payment.method: credit_card\n\u2514\u2500\u2500 order.fulfill (5ms)\n"})}),"\n",(0,s.jsx)(n.h2,{id:"using-with-tracing-plugin",children:"Using with Tracing Plugin"}),"\n",(0,s.jsx)(n.p,{children:"For automatic tracing of all tools, resources, and prompts:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"import { MCPServer, tracingPlugin, createTracer, consoleExporter } from '@mcpkit-dev/core';\n\nconst tracer = createTracer({\n  serviceName: 'my-server',\n  exporters: [consoleExporter()],\n});\n\n@MCPServer({\n  name: 'my-server',\n  version: '1.0.0',\n  plugins: [\n    tracingPlugin({\n      tracer,\n      // Automatically trace all tools\n      traceTools: true,\n      // Automatically trace all resources\n      traceResources: true,\n      // Automatically trace all prompts\n      tracePrompts: true,\n      // Add request attributes\n      extractRequestAttributes: (ctx) => ({\n        'request.path': ctx.path,\n        'session.id': ctx.sessionId,\n      }),\n    }),\n  ],\n})\nclass MyServer {\n  // All methods are automatically traced!\n  @Tool({ description: 'My tool' })\n  async myTool() {\n    return 'result';\n  }\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"tracer-configuration-reference",children:"Tracer Configuration Reference"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"interface TracerOptions {\n  // Service identification\n  serviceName: string;\n  serviceVersion?: string;\n  environment?: string;\n\n  // Span exporters\n  exporters: TracerExporter[];\n\n  // Sampling (default: always sample)\n  sampler?: 'always' | 'never' | { ratio: number };\n\n  // Resource attributes\n  resourceAttributes?: Record<string, string>;\n}\n\n// Exporter types\ntype TracerExporter =\n  | { type: 'console' }\n  | { type: 'memory' }\n  | {\n      type: 'otlp';\n      endpoint: string;\n      headers?: Record<string, string>;\n    };\n\n// Helper functions\nconst consoleExporter = () => ({ type: 'console' });\nconst memoryExporter = () => ({ type: 'memory', getSpans: () => [...], clear: () => void });\n"})}),"\n",(0,s.jsx)(n.h2,{id:"span-attributes-convention",children:"Span Attributes Convention"}),"\n",(0,s.jsx)(n.p,{children:"MCPKit follows OpenTelemetry semantic conventions:"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Attribute"}),(0,s.jsx)(n.th,{children:"Description"}),(0,s.jsx)(n.th,{children:"Example"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"mcp.tool.name"})}),(0,s.jsx)(n.td,{children:"Tool name"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:'"fetchUser"'})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"mcp.resource.uri"})}),(0,s.jsx)(n.td,{children:"Resource URI"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:'"file:///data.json"'})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"mcp.prompt.name"})}),(0,s.jsx)(n.td,{children:"Prompt name"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:'"greeting"'})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"mcp.session.id"})}),(0,s.jsx)(n.td,{children:"Session ID"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:'"abc-123"'})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"error.type"})}),(0,s.jsx)(n.td,{children:"Error class name"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:'"ValidationError"'})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"error.message"})}),(0,s.jsx)(n.td,{children:"Error message"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:'"Invalid input"'})})]})]})]}),"\n",(0,s.jsx)(n.h2,{id:"error-handling",children:"Error Handling"}),"\n",(0,s.jsx)(n.p,{children:"Errors are automatically captured in spans:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'@Tool({ description: \'Risky operation\' })\n@Traced()\nasync riskyOperation() {\n  throw new Error(\'Something went wrong\');\n}\n\n// Span will have:\n// - status: "error"\n// - error.type: "Error"\n// - error.message: "Something went wrong"\n// - error.stack: "Error: Something went wrong\\n    at..."\n'})}),"\n",(0,s.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Set up tracer at application startup"}),", before any traced code runs"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Use meaningful span names"})," that describe the operation"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Add relevant attributes"})," for debugging (user ID, request ID, etc.)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Use appropriate span kinds"}),": server for handlers, client for outbound calls"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Don't over-trace"}),": Focus on important operations, not every function"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Use sampling in production"})," to reduce overhead: ",(0,s.jsx)(n.code,{children:"sampler: { ratio: 0.1 }"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Include service version"})," for tracking deployments"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"see-also",children:"See Also"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/mcpkit/docs/observability/overview",children:"Observability Overview"})," - Complete observability guide"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/mcpkit/docs/observability/tracing",children:"Tracing Configuration"})," - Advanced tracing setup"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/mcpkit/docs/guides/debugging",children:"Debugging Guide"})," - @Debug and @Monitor decorators"]}),"\n"]})]})}function p(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}}}]);